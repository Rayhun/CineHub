{% extends "base.html" %}

{% block title %}Search Movies - CineHub{% endblock %}

{% block content %}
  <section class="search-section py-5">
    <div class="container">
      <h2 class="mb-4">Search &amp; Filter Movies</h2>
      
      <form action="{% url 'movies:search' %}" method="get">
        <div class="search-wrapper mb-4">
          <input type="text" name="q" class="form-control search-input" id="searchInput" placeholder="Search movies, series, anime..." value="{{ query }}">
          <button class="btn btn-danger search-btn" type="submit"><i class="fas fa-search"></i></button>
        </div>

        <div class="row">
          <!-- Filters Sidebar -->
          <div class="col-md-3 mb-4">
            <div class="filters-card">
              <h5 class="mb-4">
                <i class="fas fa-filter"></i> Filters
                <a class="btn btn-sm btn-outline-danger float-end" href="{% url 'movies:search' %}" id="resetFilters">Reset</a>
              </h5>

              <!-- Category Filter -->
              <div class="filter-group mb-4">
                <h6>Category</h6>
                {% for category in categories %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cat-{{ category.slug }}" name="categories" value="{{ category.slug }}" {% if category.slug in active_categories %}checked{% endif %} onchange="this.form.submit()">
                    <label class="form-check-label" for="cat-{{ category.slug }}">{{ category.name }}</label>
                  </div>
                {% empty %}
                  <p class="text-muted">No categories available yet.</p>
                {% endfor %}
              </div>

              <!-- Language Filter -->
              <div class="filter-group mb-4">
                <h6>Language</h6>
                {% for language in languages %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="lang-{{ language.slug }}" name="languages" value="{{ language.slug }}" {% if language.slug in active_languages %}checked{% endif %} onchange="this.form.submit()">
                    <label class="form-check-label" for="lang-{{ language.slug }}">{{ language.name }}</label>
                  </div>
                {% empty %}
                  <p class="text-muted">No languages found.</p>
                {% endfor %}
              </div>

              <!-- Year Filter -->
              <div class="filter-group mb-4">
                <h6>Year</h6>
                <select class="form-select" id="yearFilter" name="year" onchange="this.form.submit()">
                  <option value="">All Years</option>
                  {% for year_choice in year_choices %}
                    <option value="{{ year_choice }}" {% if year_choice|stringformat:"s" == active_year|stringformat:"s" %}selected{% endif %}>
                      {{ year_choice }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <!-- Quality Filter -->
              <div class="filter-group mb-4">
                <h6>Quality</h6>
                {% for value, label in quality_choices %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="quality-{{ value|slugify }}" name="qualities" value="{{ value }}" {% if value in active_qualities %}checked{% endif %} onchange="this.form.submit()">
                    <label class="form-check-label" for="quality-{{ value|slugify }}">{{ label }}</label>
                  </div>
                {% empty %}
                  <p class="text-muted">Quality filters coming soon.</p>
                {% endfor %}
              </div>

              <!-- Sort -->
              <div class="filter-group">
                <h6>Sort By</h6>
                <select class="form-select" id="sortFilter" name="sort" onchange="this.form.submit()">
                  {% for value, label in sort_options %}
                    <option value="{{ value }}" {% if value == active_sort %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <!-- Search Results -->
          <div class="col-md-9">
            <div class="results-header mb-4 d-flex justify-content-between align-items-center">
              <p class="text-muted mb-0">Showing <strong id="resultCount">{{ movies|length }}</strong> results</p>
              {% if query %}
                <span class="badge bg-secondary">Query: "{{ query }}"</span>
              {% endif %}
            </div>

            <div class="row g-4" id="searchResults">
              {% for movie in movies %}
                <div class="col-6 col-md-4 col-lg-3">
                  <div class="movie-card">
                    <div class="movie-poster">
                      {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
                      {% else %}
                        <img src="https://via.placeholder.com/300x450?text={{ movie.title|urlencode }}" alt="{{ movie.title }}">
                      {% endif %}
                      <div class="movie-overlay">
                        <a href="{{ movie.get_absolute_url }}" class="btn btn-danger btn-sm">
                          <i class="fas fa-info-circle"></i> Details
                        </a>
                      </div>
                      {% if movie.quality %}
                        <span class="quality-badge">{{ movie.get_quality_display }}</span>
                      {% endif %}
                    </div>
                    <div class="movie-info">
                      <h5>{{ movie.title }}</h5>
                      {% with language_list=movie.language_names %}
                        <p class="movie-meta">
                          <span class="year">{{ movie.release_year }}</span>
                          {% if language_list %}
                            <span class="language">{{ language_list|join:", " }}</span>
                          {% endif %}
                        </p>
                      {% endwith %}
                      {% if movie.rating %}
                        <div class="rating">
                          <i class="fas fa-star text-warning"></i> {{ movie.rating }}/10
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="col-12">
                  <div class="alert alert-warning">
                    <h5 class="alert-heading">No results found</h5>
                    <p>Try adjusting your filters or search keywords to discover more movies.</p>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>
{% endblock %}
